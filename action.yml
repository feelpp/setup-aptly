name: 'Setup aptly'
description: 'Install aptly package manager from GitHub releases and optionally publish packages'
branding:
  icon: 'package'
  color: 'blue'

inputs:
  version:
    description: 'The version of aptly to install'
    required: false
    default: '1.6.2'
  architecture:
    description: 'The architecture to install'
    required: false
    default: 'amd64'
  cache:
    description: 'Enable caching of aptly installation'
    required: false
    default: 'true'
  publish:
    description: 'Whether to publish packages to APT repository'
    required: false
    default: 'false'
  component:
    description: 'APT component name'
    required: false
    default: ''
  distribution:
    description: 'APT distribution (e.g. noble, jammy)'
    required: false
    default: 'noble'
  channel:
    description: 'Publication channel (stable, testing, pr)'
    required: false
    default: 'stable'
  debs-path:
    description: 'Path to .deb files to publish'
    required: false
    default: ''
  sign:
    description: 'Sign the publication with GPG'
    required: false
    default: 'false'
  gpg-key-id:
    description: 'GPG key ID for signing (required if sign=true)'
    required: false
    default: ''
  gpg-passphrase:
    description: 'GPG passphrase (optional, can use GPG agent)'
    required: false
    default: ''
  apt-repo-path:
    description: 'Path to the APT scripts directory (feelpp/apt main branch checkout)'
    required: false
    default: '.'
  auto-bump:
    description: 'Auto-bump Debian revision if package version already exists (default: false, use force-overwrite instead)'
    required: false
    default: 'false'

outputs:
  aptly-version:
    description: 'The installed version of aptly'
    value: ${{ steps.install.outputs.aptly-version || steps.cache-output.outputs.aptly-version }}
  aptly-path:
    description: 'The path to the aptly executable'
    value: ${{ steps.install.outputs.aptly-path || steps.cache-output.outputs.aptly-path }}
  published:
    description: 'Whether packages were published'
    value: ${{ steps.publish.outputs.published }}
  publication-url:
    description: 'URL of the published APT repository'
    value: ${{ steps.publish.outputs.publication-url }}

runs:
  using: 'composite'
  steps:
    - name: Determine platform
      id: platform
      shell: bash
      run: |
        case "${{ runner.os }}" in
          Linux)
            echo "os=linux" >> $GITHUB_OUTPUT
            ;;
          macOS)
            echo "os=darwin" >> $GITHUB_OUTPUT
            ;;
          Windows)
            echo "os=windows" >> $GITHUB_OUTPUT
            ;;
          *)
            echo "Unsupported OS: ${{ runner.os }}"
            exit 1
            ;;
        esac

    - name: Set cache key
      id: cache-key
      shell: bash
      run: |
        echo "cache-key=aptly-${{ inputs.version }}-${{ steps.platform.outputs.os }}-${{ inputs.architecture }}" >> $GITHUB_OUTPUT

    - name: Cache aptly installation
      if: inputs.cache == 'true'
      id: cache
      uses: actions/cache@v4
      with:
        path: ~/.local/bin/aptly
        key: ${{ steps.cache-key.outputs.cache-key }}

    - name: Install aptly
      id: install
      if: inputs.cache != 'true' || steps.cache.outputs.cache-hit != 'true'
      shell: bash
      run: |
        set -euo pipefail

        VERSION="${{ inputs.version }}"
        ARCH="${{ inputs.architecture }}"
        OS="${{ steps.platform.outputs.os }}"

        echo "Installing aptly version ${VERSION} for ${OS}_${ARCH}"

        # Map arm64 to arm64 for aptly downloads (if needed)
        case "${ARCH}" in
          "arm64")
            APTLY_ARCH="arm64"
            ;;
          "amd64"|"x86_64")
            APTLY_ARCH="amd64"
            ;;
          *)
            APTLY_ARCH="${ARCH}"
            ;;
        esac

        mkdir -p ~/.local/bin

        DOWNLOAD_URL="https://github.com/aptly-dev/aptly/releases/download/v${VERSION}/aptly_${VERSION}_${OS}_${APTLY_ARCH}.zip"
        TEMP_DIR=$(mktemp -d)

        echo "Downloading from: ${DOWNLOAD_URL}"
        curl -fsSL "${DOWNLOAD_URL}" -o "${TEMP_DIR}/aptly.zip"

        cd "${TEMP_DIR}"
        unzip -q aptly.zip

        APTLY_DIR=$(find . -name "aptly_${VERSION}_${OS}_${APTLY_ARCH}" -type d | head -1)
        if [[ -z "${APTLY_DIR}" ]]; then
          echo "Error: Could not find aptly directory in archive"
          exit 1
        fi

        if [[ ! -f "${APTLY_DIR}/aptly" ]]; then
          echo "Error: aptly binary not found in ${APTLY_DIR}"
          exit 1
        fi

        cp "${APTLY_DIR}/aptly" ~/.local/bin/aptly
        chmod +x ~/.local/bin/aptly

        rm -rf "${TEMP_DIR}"

        echo ~/.local/bin >> $GITHUB_PATH

        INSTALLED_VERSION=$(~/.local/bin/aptly version | grep "aptly version:" | cut -d' ' -f3)
        echo "Successfully installed aptly version: ${INSTALLED_VERSION}"

        echo "aptly-version=${INSTALLED_VERSION}" >> $GITHUB_OUTPUT
        echo "aptly-path=~/.local/bin/aptly" >> $GITHUB_OUTPUT

    - name: Set outputs from cache
      if: inputs.cache == 'true' && steps.cache.outputs.cache-hit == 'true'
      id: cache-output
      shell: bash
      run: |
        echo ~/.local/bin >> $GITHUB_PATH

        INSTALLED_VERSION=$(~/.local/bin/aptly version | grep "aptly version:" | cut -d' ' -f3)
        echo "Using cached aptly version: ${INSTALLED_VERSION}"

        echo "aptly-version=${INSTALLED_VERSION}" >> $GITHUB_OUTPUT
        echo "aptly-path=~/.local/bin/aptly" >> $GITHUB_OUTPUT

    - name: Verify installation
      shell: bash
      run: |
        echo "Verifying aptly installation..."
        aptly version
        echo "aptly installed successfully at: $(which aptly)"

    - name: Setup uv
      if: inputs.publish == 'true'
      uses: astral-sh/setup-uv@v7

    - name: Publish to APT repository
      if: inputs.publish == 'true'
      id: publish
      shell: bash
      run: |
        set -euo pipefail

        if [[ -z "${{ inputs.component }}" ]]; then
          echo "Error: component is required when publish=true"
          exit 1
        fi

        if [[ -z "${{ inputs.debs-path }}" ]]; then
          echo "Error: debs-path is required when publish=true"
          exit 1
        fi

        APT_SCRIPTS_PATH="${{ inputs.apt-repo-path }}"
        echo "Working with APT scripts at: $APT_SCRIPTS_PATH"

        # Install feelpp-aptly-publisher
        echo "Installing feelpp-aptly-publisher..."
        if [ -f "$APT_SCRIPTS_PATH/pyproject.toml" ]; then
          uv venv .venv-publish
          source .venv-publish/bin/activate
          cd "$APT_SCRIPTS_PATH"
          uv pip install -e .
          cd -
        else
          uv pip install feelpp-aptly-publisher
        fi

        DEB_FILES="${{ inputs.debs-path }}"
        if [[ "$DEB_FILES" != /* ]]; then
          DEB_FILES="$GITHUB_WORKSPACE/$DEB_FILES"
        fi

        echo "Looking for .deb files in: $DEB_FILES"
        if ! ls ${DEB_FILES}/*.deb 1> /dev/null 2>&1; then
          echo "No .deb files found in: $DEB_FILES"
          ls -la "$DEB_FILES" || echo "Directory does not exist"
          exit 1
        fi

        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

        # Clear any aptly environment variables
        unset APTLY_CONFIG
        unset APTLY_ROOT_DIR
        unset APTLY_ROOT
        unset APTLY_DB_DIR

        # Run feelpp-apt-publish
        echo "Publishing packages to ${{ inputs.channel }}/${{ inputs.distribution }}/${{ inputs.component }}..."
        
        PUBLISH_ARGS=(
          --component "${{ inputs.component }}"
          --distro "${{ inputs.distribution }}"
          --channel "${{ inputs.channel }}"
          --debs "$DEB_FILES"
          --verbose
        )
        
        # Add signing parameters if requested
        if [[ "${{ inputs.sign }}" == "true" ]]; then
          if [[ -z "${{ inputs.gpg-key-id }}" ]]; then
            echo "Error: gpg-key-id is required when sign=true"
            exit 1
          fi
          PUBLISH_ARGS+=(--sign --keyid "${{ inputs.gpg-key-id }}")

          if [[ -n "${{ inputs.gpg-passphrase }}" ]]; then
            PUBLISH_ARGS+=(--passphrase "${{ inputs.gpg-passphrase }}")
          fi
        fi

        # Add auto-bump if enabled (default: true)
        if [[ "${{ inputs.auto-bump }}" == "true" ]]; then
          PUBLISH_ARGS+=(--auto-bump)
        fi

        feelpp-apt-publish "${PUBLISH_ARGS[@]}" publish

        echo "published=true" >> $GITHUB_OUTPUT

        # Determine publication URL
        REPO_OWNER=$(echo "${{ github.repository }}" | cut -d'/' -f1)
        PAGES_URL="https://${REPO_OWNER}.github.io/apt"
        echo "publication-url=${PAGES_URL}/${{ inputs.channel }}/dists/${{ inputs.distribution }}/" >> $GITHUB_OUTPUT
